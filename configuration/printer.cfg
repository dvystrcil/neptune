####################################################################################
# Machine type: NEPTUNE 4 PRO
# Current configuration version: V1.4
# Date：2023-12-1
####################################################################################
# This product (Neptune 4/4pro/4plus/4max) adopts Klipper firmware 
# and does not support users to update the official klipper/fluidd
# /moonraker by themselves, otherwise the machine will not work properly.
# If you want to DIY and are an expert or interested in this field, 
# we recommend that you prepare your own tools for burning images so 
# that you can restore them if problems arise. Please contact after-sales 
# support team for tutorials on burning images. Thank you for your cooperation!
####################################################################################
# This file contains common pin mappings for ZNP-K1-V1.0 
# boards. To use this config, the firmware should be compiled for the
# STM32F402. When running "make menuconfig", enable "extra low-level
# configuration setup", select the 32KiB bootloader, and serial (on
# USART1 PA10/PA9) communication.

# The "make flash" command does not work on the ZN-K1-V1.0. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "elegoo_k1.bin" on an SD card and then restart the ZNP-K1-V1.0
# with that SD card.

# See docs/Config_Reference.md for a description of parameters.
####################################################################################


[include plr.cfg]

[include neptune4pro_autotune.cfg]

[include btt-eddy-zoffset.cfg]

#[include adxlmcu.cfg]

[auto_speed]
margin: 2.5 ; How far away from your axes to perform movements
accel_min: 1000.0 ; Minimum acceleration test may try
accel_max: 30000.0 ; Maximum acceleration test may try

velocity_min: 50.0 ; Minimum velocity test may try
velocity_max: 700.0 ; Maximum velocity test may try

[mcu]
# The hardware use USART1 PA10/PA9 connect to RK3328
serial: /dev/ttyS0
restart_method: command

[stepper_x]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PC0
position_min: -8.5  
position_endstop:-8
position_max: 238.7
homing_speed:50
homing_retract_dist:5
homing_positive_dir:false

[stepper_y]
step_pin:PB4
dir_pin:PB3
enable_pin:!PB5
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PB8
position_min: -0.5
position_endstop: 0 
position_max:238.7
homing_speed:50
homing_retract_dist:5
homing_positive_dir:false


[stepper_z]
step_pin:PC10
dir_pin:!PA15
enable_pin: !PC11
microsteps: 32 #16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop ## PB12 for Z-max; endstop have'!' is NO

##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##	Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop:-5
position_max: 268
position_min: -12
homing_speed: 8
homing_retract_dist: 5
second_homing_speed: 3

[extruder]
step_pin:PA5
dir_pin:!PA6
enable_pin:!PA4
microsteps: 64 #16
rotation_distance: 28.994 #29.0  #31.4	#Bondtech 5mm Drive Gears
gear_ratio: 52:10
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 310
heater_pin: PA7
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin: PA1
max_power: 1
#control :pid
#pid_kp : 26.213
#pid_ki : 1.304
#pid_kd : 131.721
pressure_advance: 0.022
pressure_advance_smooth_time: 0.04
instantaneous_corner_velocity: 2.5
max_extrude_only_distance: 300
max_extrude_only_velocity:60
max_extrude_only_accel:5000
max_extrude_cross_section: 9999999
min_extrude_temp:100

[verify_heater extruder]
max_error: 120
check_gain_time:30
hysteresis: 10
heating_gain: 2

[heater_bed]
heater_pin:PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
#control : pid
#pid_kp : 75.397
#pid_ki : 0.823
#pid_kd : 1727.531
pwm_cycle_time: 0.016
min_temp: 0
max_temp: 120


[verify_heater heater_bed]
max_error: 120
check_gain_time:30
hysteresis: 10
heating_gain: 2



[respond]
default_type: echo
default_prefix: echo:

[virtual_sdcard]
path: ~/gcode_files
on_error_gcode:  
    # test OK
    G91
    G1 Z25 F900
    G90
    TURN_OFF_HEATERS
    M106 S100
    M84
    M300 P10000 S1
    G4 P300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300

########################################
# PRINT_START/CANCEL_PRINT/PAUSE/RESUME/filament_switch_sensor
########################################

[print_stats]

[gcode_move]

    
[gcode_macro PRINT_START]         
gcode:
    G28
    SKEW_PROFILE LOAD=CaliFlower
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
	  G92 E0   
    BED_MESH_CLEAR                                     
	  G90    
    BED_MESH_CALIBRATE ADAPTIVE=1 METHOD=rapid_scan algorithm=bicubic    
    CLEAR_PAUSE
    M117 Printing                   
    
[gcode_macro PRINT_END]
gcode:
    SET_SKEW CLEAR=1
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    {% set RUN_CRUISE   = printer.configfile.settings['printer'].minimum_cruise_ratio|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} MINIMUM_CRUISE_RATIO={RUN_CRUISE}
    M220 S100
    M221 S100
    {% set z = params.Z|default(100)|int %} 
    {% if (printer.gcode_move.position.z+5) < z %}
      G90 
      G1 Z{z+5} F6000 
    {% endif %}
    TURN_OFF_HEATERS
    M107
    M84


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    {% set RUN_CRUISE   = printer.configfile.settings['printer'].minimum_cruise_ratio|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} MINIMUM_CRUISE_RATIO={RUN_CRUISE}
    {% set z = params.Z|default(100)|int %}  
    {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
    {% set y_park = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %} 
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} 
    SDCARD_RESET_FILE
    M220 S100
    M221 S100
    M400
    G91
    M83
    G1 E-10.0 F1200
    TURN_OFF_HEATERS
    M107
    {% if (printer.gcode_move.position.z+5) < z %}
    G90
    G0 X{x_park} Y{y_park} Z{z+5} F6000
    {% endif %}
    {%if (printer.gcode_move.position.z+5) >= z %}
    {%if (printer.gcode_move.position.z+5) < printer.toolhead.axis_maximum.z %}
    G91
    G1 Z5 F300
    G90
    G0 X{x_park} Y{y_park} F6000
    {% else %}
    G90
    G0 X{x_park} Y{y_park} Z{printer.toolhead.axis_maximum.z} F6000
    {% endif %}
    {% endif %}
    M84

[pause_resume]
recover_velocity: 50.0 

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    M400 
    {% set z = params.Z|default(30)|int %}                                                   
    {% set E = (params.E|default(2))|float %}
    {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
    {% set y_park = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %} 
                                                                                  
    {% if (printer.gcode_move.position.x) <= (x_park+1) and (printer.gcode_move.position.y) >= (y_park-1) %}
      M400 
    {% else %}
      {% set position = printer.gcode_move.gcode_position %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_x VALUE="{position.x}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_y VALUE="{position.y}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_z VALUE="{position.z}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_e VALUE="{position.e}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}   
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed_temp VALUE={printer['heater_bed'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed1_temp VALUE={printer['heater_generic heater_bed1'].target}
        SAVE_GCODE_STATE NAME=timelapse_state_a
        M83
        G91
      {% if (printer.gcode_move.position.z+5) <  printer.toolhead.axis_maximum.z  %} 
        G1 E-2 X3 Z1 F2100
        G1 Z4 F600
      {% endif %}
        SAVE_GCODE_STATE NAME=timelapse_state_b
        G90
      {% if (printer.gcode_move.position.z+5) < z %}
        G1 Z{z+5} X{x_park} Y{y_park} E-20 F6000 
      {% else %}
        G1 X{x_park} Y{y_park} E-20 F6000
      {% endif %}
        M400
        M25
        SET_IDLE_TIMEOUT TIMEOUT=1200
        M400
    {% endif %}
                                                           


[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_bed_temp: 0
variable_bed1_temp: 0
variable_saved_x: 0.0
variable_saved_y: 0.0
variable_saved_z: 0.0
variable_saved_e: 0.0
gcode:
    M24
    {% set e = params.E|default(2)|int %}   
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    {% if printer[printer.toolhead.extruder].temperature < etemp-4 %}   
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}   
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
      SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={bed1_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={etemp-4} MAXIMUM={etemp+10}   
    {% endif %} 
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}   
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={bed1_temp}
    M17 E
    G91
    M83
    G1 E100 F200	
    G4 P2000	
    G1 X20 F15000
    G1 X-20
    G1 X20
    G1 X-20
    G1 X20
    G1 X-20
    ;G1 E-2 F600
    G90
    G92 E{saved_e}
    RESTORE_GCODE_STATE NAME=timelapse_state_b MOVE=1 MOVE_SPEED=250
    RESTORE_GCODE_STATE NAME=timelapse_state_a MOVE=1 MOVE_SPEED=250 
    SAVE_GCODE_STATE NAME=timelapse_state_a
    SAVE_GCODE_STATE NAME=timelapse_state_b
    M400
    ;M24

[filament_switch_sensor fila]
pause_on_runout: True
runout_gcode:
    SET_FILAMENT_SENSOR SENSOR=fila ENABLE=1
    M118 ;Filament detection is triggered,please check.
insert_gcode:
event_delay: 3.0
pause_delay: 1.0
switch_pin: PA12

##############################################################


#fan for printed model FAN0
[fan]
pin: PC9

#fan for hotend FAN1
[heater_fan fan1]
pin: PA8
fan_speed: 0.4
shutdown_speed: 1

[printer]
kinematics:cartesian
max_velocity: 500
max_accel: 23516
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 9.0

####################################################################
#	Input Shapping
#####################################################################

#[adxl345]
#cs_pin: rpi:None
#spi_bus: spidev0.2

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    100, 100, 20  # an example

[input_shaper]
#shaper_type_x = ei
#shaper_freq_x = 79.2
#shaper_type_y = mzv
#shaper_freq_y = 48.2
#damping_ratio_x: 0.1
#damping_ratio_y: 0.1

####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################
[idle_timeout]
timeout: 3600
gcode:
  {% if printer[printer.toolhead.extruder].temperature > 140 %}   # Reduce the hot end temperature after 10 minutes
  {action_respond_info("Extruder powered down on idle timeout.")}
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={120}       # After pausing printing, reduce nozzle temperature to 50℃
  M84 E
  # SET_IDLE_TIMEOUT TIMEOUT=259200       # Timer duration 3 days.
  {% else %}
  TURN_OFF_HEATERS
  M84 E
  {% endif %}

# are we still using this?
[gcode_macro G29]
gcode:
      M400
      BED_MESH_CLEAR
      G28
      PREHEAT_BED_PLA
      BED_MESH_CALIBRATE PROFILE=6 METHOD=rapid_scan algorithm=bicubic
      #BED_MESH_CALIBRATE profile=6 mesh_min=15,21 mesh_max=210,220 probe_count=6 algorithm=bicubic
      M400
      G4 P2000
      G91 
      G1 Z5 F300 
      G90
      G28 Z
      G1 X117.5 Y117.5 F12000
      G1 Z0 F300


[screws_tilt_adjust]
screw1_name: front left screw
screw1: 68.66, 0.84
screw2_name: rear left screw
screw2: 68.66, 170.84
screw3_name: rear right screw
screw3: 238.66, 170.84 
screw4_name: front right screw
screw4: 238.66, 0.84  
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4  # Use CW for Clockwise and CCW for Counter Clockwise

[skew_correction] 

#####################################################################
# LED Control
#####################################################################
# LED Control 1.0
[output_pin caselight]
pin: PB7
pwm: false
shutdown_value:0
value:0.0

[output_pin caselight1]
pin: PC7
pwm: false
shutdown_value:0
value:0.0

[gcode_macro FLASHLIGHT_ON]
description: Turn on Hotend LEDs
gcode:
  SET_PIN PIN=caselight VALUE=1


[gcode_macro FLASHLIGHT_OFF]
description: Turn off Hotend LEDs
gcode:
  SET_PIN PIN=caselight VALUE=0


[gcode_macro MODLELIGHT_ON]
description: Turn on Logo LEDs
gcode:
  SET_PIN PIN=caselight1 VALUE=1


[gcode_macro MODLELIGHT_OFF]
description: Turn off Logo LEDs
gcode:
  SET_PIN PIN=caselight1 VALUE=0

# LED Control 2.0
[gcode_macro FLASHLIGHT_SWITCH]
description: Switch Hotend LEDs
gcode:
  RUN_SHELL_COMMAND CMD=FLASHLIGHT

[gcode_shell_command FLASHLIGHT]
command: sh /home/mks/sled2.sh
timeout: 5.

[gcode_macro MODLELIGHT_SWITCH]
description: Switch Logo LEDs
gcode:
  RUN_SHELL_COMMAND CMD=MODLELIGHT

[gcode_shell_command MODLELIGHT]
command: sh /home/mks/sled1.sh
timeout: 5.

########################################
# TMC UART configuration
########################################

[tmc2209 stepper_x]
uart_pin: PB9
run_current: 1.0
hold_current: 0.8
interpolate: True
#stealthchop_threshold:0

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 1.2
hold_current: 0.8
interpolate: True
#stealthchop_threshold:0

[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.8
hold_current: 0.5
interpolate: True
#stealthchop_threshold: 0

[tmc2209 extruder]
uart_pin: PC4
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[mcu rpi]
serial: /tmp/klipper_host_mcu




  
[display_status]


[gcode_macro M17]
gcode:
  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
      #SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}



[gcode_macro M84]
rename_existing:M84.1
gcode:

  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}



[delayed_gcode KINEMATIC_POSITION]
initial_duration:3.0
gcode:
      SET_KINEMATIC_POSITION X=110
      SET_KINEMATIC_POSITION Y=110
      SET_KINEMATIC_POSITION Z=0


####################################################################
#	Configuration related to partition heating
#####################################################################
[heater_generic heater_bed1]
gcode_id:M105
heater_pin:PC8
max_power:1.0
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin:PC2
control: pid
pid_kp: 70.818
pid_ki: 0.637
pid_kd: 1967.864
pwm_cycle_time: 0.016
min_temp: 0
max_temp: 120

[verify_heater heater_bed1] 
max_error: 600 
check_gain_time:120 
hysteresis: 10    
heating_gain: 2 

[gcode_macro M191]
gcode:
      {% set s = (params.S|float,120)|min %}
      {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
        {% if printer.heater_bed.temperature <= s-2 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
        # G4 P20000
        # {% else %}
        # G4 P10000
        {% endif %}   
      {% else %}
      M140 S0
      {% endif %}   
	  
[gcode_macro M190]
rename_existing: M99190
gcode:
      {% set s = (params.S|float,120)|min %}
      {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
        {% if printer.heater_bed.temperature <= s-2 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
        # G4 P20000
        # {% else %}
        # G4 P10000
        {% endif %}   
      {% else %}
      M140 S0
      {% endif %} 
	   
[gcode_macro M140]
rename_existing: M99140
gcode:
      {% set s = (params.S|float,120)|min %}
	    {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
      {% else %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
      SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET=0
	    {% endif %} 

[gcode_macro M141]
gcode:
       {% set s = (params.S|float,120)|min %}
       {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
       {% else %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET=0
       {% endif %} 

#############################################################################
#   PID Tuning Macros
#############################################################################

[gcode_macro PID_Tune_EXTRUDER]
gcode:
  {% set temperature = params.TEMPERATURE|default(210) %}
  G28
  M106 S255
  PID_CALIBRATE HEATER=extruder TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
  M106 S255 ;Sets Print Fans to 100%
  PID_CALIBRATE HEATER=heater_bed TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_Outer_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
  M106 S255 ;Sets Print Fans to 100%
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={temperature} 	;Heats Inner Zone at the same time for better tuning 
  PID_CALIBRATE HEATER=heater_bed1 TARGET={temperature}
  SAVE_CONFIG   

#############################################################################
#   Fan & Temp Monitoring Config
#############################################################################

[temperature_sensor RockchipHost]
sensor_type: temperature_host
min_temp: 10
max_temp: 80

[temperature_sensor STM32MCU]
sensor_type: temperature_mcu
min_temp: 10
max_temp: 85

####################################################################
## G-code macro definition
#####################################################################

[gcode_macro M205]
description: Sets square corner velocity.
  Usage: M205 [X<velocity>] [Y<velocity>]
gcode:
  {% set max_square_corner_velocity = 30 %}
  {% if 'X' in params or 'Y' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY="{(params.X|default(0)|float, params.Y|default(0)|float,max_square_corner_velocity)|min}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro M203]
description: Sets maximum velocity.
  Usage: M203 [X<velocity>] [Y<velocity>]
gcode:
  {% if 'X' in params or 'Y' in params %}
    {% set velocity = (params.X|default(params.Y)|float,
                       params.Y|default(params.X)|float,500)|min %}
    SET_VELOCITY_LIMIT VELOCITY="{velocity}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro m600]
description: Pauses the current print.
  Usage: M600 [B<beeps>] [E<pos>] [L<pos>] [R<temp>] [U<pos>] [X<pos>] [Y<pos>]
              [Z<pos>]
gcode:
  PAUSE P=2{% for k in params|select("in", "BEXYZ") %}{
      ' '~k~'="'~params[k]~'"'}{% endfor %}



################ Buzzer configuration ##################
[output_pin beeper]
pin: PA2
pwm: true
shutdown_value:0
value:0.0


[gcode_macro m300]
description: Emits and audible beep.
  Usage: M300 [P<duration>] [S<frequency>]
gcode:
  {% set settings = printer.configfile.settings %}
  {% if "output_pin beeper" in printer %}
    {% set P = (params.P|default(100)|int, 0)|max %}
    {% set S = (params.S|default(1000)|int, 10000)|min %}
    SET_PIN PIN=beeper VALUE={
        settings["output_pin beeper"].scale|default(1.0) * 0.5
      }{% if settings["output_pin beeper"].pwm %} CYCLE_TIME={
        1.0 / S }{% endif %}
    G4 P{P}
    SET_PIN PIN=beeper VALUE=0
  {% else %}
    {action_respond_info(
       "M300 is disabled. To enable create an [output_pin beeper] config.")}
  {% endif %}
  

[gcode_arcs]
resolution: 0.1

[exclude_object]

[gcode_macro PREHEAT_BED_PLA]
gcode:
  M190 S60

[gcode_macro PREHEAT_BED_PETG]
gcode:
  M190 S75

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3296460.249,0.090000:3295706.969,0.130000:3294953.606,
#*# 	0.170000:3294215.873,0.210000:3293460.206,0.250000:3292755.999,
#*# 	0.290000:3292052.364,0.330000:3291334.083,0.370000:3290617.729,
#*# 	0.410000:3289956.858,0.450000:3289269.790,0.490000:3288627.545,
#*# 	0.530000:3287956.232,0.570000:3287333.842,0.610000:3286699.517,
#*# 	0.650000:3286053.739,0.690000:3285452.199,0.730000:3284843.439,
#*# 	0.770000:3284266.833,0.810000:3283692.452,0.850000:3283081.824,
#*# 	0.890000:3282547.688,0.930000:3281976.987,0.970000:3281444.259,
#*# 	1.010000:3280913.971,1.050000:3280366.886,1.090000:3279848.869,
#*# 	1.130000:3279342.068,1.170000:3278841.851,1.210000:3278372.104,
#*# 	1.250000:3277873.550,1.290000:3277426.192,1.330000:3276930.038,
#*# 	1.370000:3276466.584,1.410000:3276019.263,1.450000:3275569.219,
#*# 	1.490000:3275128.948,1.530000:3274689.043,1.570000:3274258.960,
#*# 	1.610000:3273851.892,1.650000:3273445.685,1.690000:3273060.542,
#*# 	1.730000:3272655.698,1.770000:3272245.059,1.810000:3271874.541,
#*# 	1.850000:3271519.434,1.890000:3271133.850,1.930000:3270754.523,
#*# 	1.970000:3270366.653,2.010000:3270055.332,2.050000:3269711.312,
#*# 	2.090000:3269393.196,2.130000:3269024.579,2.170000:3268707.704,
#*# 	2.210000:3268395.724,2.250000:3268056.184,2.290000:3267768.531,
#*# 	2.330000:3267466.578,2.370000:3267168.614,2.410000:3266874.471,
#*# 	2.450000:3266552.130,2.490000:3266312.595,2.530000:3265998.514,
#*# 	2.570000:3265719.726,2.610000:3265446.448,2.650000:3265191.003,
#*# 	2.690000:3264888.070,2.730000:3264621.043,2.770000:3264354.659,
#*# 	2.810000:3264117.930,2.850000:3263872.654,2.890000:3263612.246,
#*# 	2.930000:3263376.991,2.970000:3263173.428,3.010000:3262908.168,
#*# 	3.050000:3262697.665,3.090000:3262475.263,3.130000:3262253.258,
#*# 	3.170000:3262007.269,3.210000:3261805.467,3.250000:3261587.507,
#*# 	3.290000:3261393.936,3.330000:3261170.929,3.370000:3260980.491,
#*# 	3.410000:3260797.696,3.450000:3260600.243,3.490000:3260400.803,
#*# 	3.530000:3260229.013,3.570000:3260031.813,3.610000:3259856.917,
#*# 	3.650000:3259667.613,3.690000:3259511.365,3.730000:3259307.224,
#*# 	3.770000:3259155.017,3.810000:3258981.448,3.850000:3258805.219,
#*# 	3.890000:3258649.578,3.930000:3258480.849,3.970000:3258346.095,
#*# 	4.010000:3258180.959,4.050000:3258025.600
#*# calibration_temp = 46.885409
#*# drift_calibration =
#*# 	3343093.324308, -833.790465, 5.677046
#*# 	3320436.695419, -540.016374, 3.183340
#*# 	3304383.518345, -360.755283, 1.702269
#*# 	3291735.080173, -215.956577, 0.527407
#*# 	3282525.942456, -134.022380, -0.049928
#*# 	3274970.147376, -56.715629, -0.643742
#*# 	3267902.296582, 52.314906, -1.620363
#*# 	3264590.766569, 42.169246, -1.414315
#*# 	3260422.598874, 96.317146, -1.891335
#*# drift_calibration_min_temp = 40.4087603294
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.703
#*# pid_ki = 2.754
#*# pid_kd = 479.842
#*#
#*# [heater_bed1]
#*# control = pid
#*# pid_kp = 70.818
#*# pid_ki = 0.637
#*# pid_kd = 1967.864
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.00330977477358
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 79.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 48.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.344
#*# pid_ki = 0.860
#*# pid_kd = 108.811
#*#
#*# [bed_mesh 6]
#*# version = 1
#*# points =
#*# 	  -0.032394, -0.029123, -0.035704, -0.035475, -0.034068, -0.035246, -0.023586, -0.026346, -0.018454, -0.022176, -0.041765, -0.083466, -0.084231, -0.076902, -0.076815, -0.090774, -0.084370, -0.084392, -0.094599, -0.093945, -0.071784
#*# 	  -0.082414, -0.071821, -0.077621, -0.083966, -0.065765, -0.069565, -0.080223, -0.069619, -0.078213, -0.074164, -0.083740, -0.087779, -0.072643, -0.074672, -0.083235, -0.078698, -0.078213, -0.087766, -0.088544, -0.095254, -0.082882
#*# 	  -0.090599, -0.083523, -0.076463, -0.080500, -0.084291, -0.075945, -0.058306, -0.054757, -0.048356, -0.054764, -0.059287, -0.055262, -0.058573, -0.071830, -0.070796, -0.082418, -0.094427, -0.101037, -0.086954, -0.080919, -0.068788
#*# 	  -0.082376, -0.084623, -0.086921, -0.091203, -0.080844, -0.081611, -0.077078, -0.082376, -0.068011, -0.072544, -0.076845, -0.064984, -0.058180, -0.067258, -0.074824, -0.062228, -0.081897, -0.070291, -0.074814, -0.076315, -0.069286
#*# 	  -0.077822, -0.076754, -0.067678, -0.057090, -0.044672, -0.048863, -0.043962, -0.043981, -0.023681, -0.010407, -0.013202, -0.013202, -0.030429, -0.047466, -0.045369, -0.051524, -0.063869, -0.056078, -0.053532, -0.066155, -0.051792
#*# 	  -0.077410, -0.062816, -0.069617, -0.073912, -0.079936, -0.071882, -0.080930, -0.066830, -0.054494, -0.039896, -0.042928, -0.049492, -0.046687, -0.040390, -0.049489, -0.058525, -0.075156, -0.073665, -0.072622, -0.064551, -0.065344
#*# 	  -0.052967, -0.050433, -0.079188, -0.044111, -0.053463, -0.042704, -0.042704, -0.016828, -0.004379, -0.002606, -0.004172, -0.017998, -0.020101, -0.047608, -0.055506, -0.058507, -0.063050, -0.067583, -0.091941, -0.064571, -0.058518
#*# 	  -0.054239, -0.053355, -0.051299, -0.059378, -0.058096, -0.057382, -0.055860, -0.042816, -0.043504, -0.027897, -0.026712, -0.025334, -0.028094, -0.039742, -0.040671, -0.055559, -0.069178, -0.061104, -0.057587, -0.052041, -0.057067
#*# 	  -0.045988, -0.049041, -0.046225, -0.037124, -0.045988, -0.043415, -0.028024, -0.007021, 0.007131, -0.002131, 0.007387, 0.004051, -0.025247, -0.042289, -0.049764, -0.048833, -0.052257, -0.064116, -0.054783, -0.053530, -0.045348
#*# 	  -0.037004, -0.041786, -0.058258, -0.053723, -0.071121, -0.067844, -0.055256, -0.045756, -0.025951, -0.020575, -0.033843, -0.039927, -0.033843, -0.039070, -0.048163, -0.043952, -0.046049, -0.063122, -0.054793, -0.064634, -0.036948
#*# 	  -0.038414, -0.051071, -0.066463, -0.044701, -0.053336, -0.055884, -0.042841, -0.025787, -0.001698, -0.001424, -0.012271, -0.004261, -0.033711, -0.042117, -0.044938, -0.055861, -0.051555, -0.052075, -0.068717, -0.061728, -0.056699
#*# 	  -0.051751, -0.046042, -0.054954, -0.043615, -0.050669, -0.048974, -0.047778, -0.035896, -0.028917, -0.025417, -0.026823, -0.033107, -0.027511, -0.049905, -0.030757, -0.028001, -0.041745, -0.041762, -0.041293, -0.049678, -0.028229
#*# 	  -0.025068, -0.045105, -0.038101, -0.032758, -0.025730, -0.023498, -0.023521, -0.004837, 0.005457, 0.005985, 0.020643, 0.002875, -0.009468, -0.019996, -0.014194, -0.029121, -0.036108, -0.024447, -0.031900, -0.031900, -0.037040
#*# 	  -0.042186, -0.038464, -0.050137, -0.056401, -0.049649, -0.036849, -0.033120, -0.028465, -0.023319, -0.026804, -0.027530, -0.040123, -0.024019, -0.017269, -0.029616, -0.015610, -0.024257, -0.023329, -0.024925, -0.036809, -0.031892
#*# 	  -0.043343, -0.060218, -0.070062, -0.053825, -0.039788, -0.034907, -0.022307, -0.018115, -0.008123, -0.000930, 0.002666, -0.010654, -0.027435, -0.027189, -0.029312, -0.032788, -0.038366, -0.027420, -0.040491, -0.047935, -0.030701
#*# 	  -0.078407, -0.077435, -0.074421, -0.068366, -0.074390, -0.069115, -0.065327, -0.054848, -0.057125, -0.055604, -0.045642, -0.053337, -0.039824, -0.034431, -0.036296, -0.037685, -0.041893, -0.054084, -0.043768, -0.039800, -0.044221
#*# 	  -0.082839, -0.084071, -0.082809, -0.079021, -0.067690, -0.063159, -0.049340, -0.057107, -0.028587, -0.026969, -0.020228, -0.035805, -0.038129, -0.036495, -0.026729, -0.033000, -0.034398, -0.042090, -0.047469, -0.060881, -0.057340
#*# 	  -0.089917, -0.076141, -0.095545, -0.094654, -0.092120, -0.082194, -0.082441, -0.085236, -0.067820, -0.074906, -0.067073, -0.054966, -0.058817, -0.046514, -0.046514, -0.039509, -0.026929, -0.049302, -0.043241, -0.058300, -0.057565
#*# 	  -0.091413, -0.103339, -0.082403, -0.084634, -0.082141, -0.078615, -0.059706, -0.049867, -0.054397, -0.040801, -0.031923, -0.038677, -0.043593, -0.044512, -0.053648, -0.042656, -0.047324, -0.049181, -0.056192, -0.071029, -0.069225
#*# 	  -0.126751, -0.106958, -0.103336, -0.100151, -0.109071, -0.099514, -0.095890, -0.091867, -0.091870, -0.084434, -0.087714, -0.070300, -0.062747, -0.052084, -0.058153, -0.049599, -0.038636, -0.049618, -0.054617, -0.068211, -0.059656
#*# 	  -0.124630, -0.136573, -0.125468, -0.131400, -0.162314, -0.139560, -0.106710, -0.103916, -0.090737, -0.100321, -0.086388, -0.070474, -0.083329, -0.084859, -0.082582, -0.071995, -0.095415, -0.116296, -0.121346, -0.103979, -0.100155
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = bicubic
#*# y_count = 21
#*# mesh_y_pps = 2
#*# min_y = 31.66
#*# x_count = 21
#*# max_y = 219.85999999999996
#*# mesh_x_pps = 2
#*# max_x = 198.79999999999998
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 35.141312
#*# drift_calibration =
#*# 	3316690.355384, -791.738399, 5.647126
#*# 	3295386.252253, -261.668920, 0.705414
#*# 	3283669.864670, -76.054556, -0.890861
#*# 	3274753.671077, 48.858304, -1.917176
#*# 	3267438.337412, 157.022932, -2.877375
#*# 	3263260.967082, 165.173675, -2.771307
#*# 	3259302.663681, 194.759102, -2.938515
#*# 	3255951.627223, 225.414963, -3.153765
#*# 	3253046.552429, 258.025038, -3.426259
#*# drift_calibration_min_temp = 35.325275233511604
