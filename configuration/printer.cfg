####################################################################################
# Machine type: NEPTUNE 4 PRO
# Current configuration version: V1.4
# Date：2023-12-1
####################################################################################
# This product (Neptune 4/4pro/4plus/4max) adopts Klipper firmware 
# and does not support users to update the official klipper/fluidd
# /moonraker by themselves, otherwise the machine will not work properly.
# If you want to DIY and are an expert or interested in this field, 
# we recommend that you prepare your own tools for burning images so 
# that you can restore them if problems arise. Please contact after-sales 
# support team for tutorials on burning images. Thank you for your cooperation!
####################################################################################
# This file contains common pin mappings for ZNP-K1-V1.0 
# boards. To use this config, the firmware should be compiled for the
# STM32F402. When running "make menuconfig", enable "extra low-level
# configuration setup", select the 32KiB bootloader, and serial (on
# USART1 PA10/PA9) communication.

# The "make flash" command does not work on the ZN-K1-V1.0. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "elegoo_k1.bin" on an SD card and then restart the ZNP-K1-V1.0
# with that SD card.

# See docs/Config_Reference.md for a description of parameters.
####################################################################################


[include plr.cfg]

#[include adxlmcu.cfg]

[mcu]
# The hardware use USART1 PA10/PA9 connect to RK3328
serial: /dev/ttyS0
restart_method: command

[stepper_x]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PC0
position_min: -8.5  
position_endstop:-8
position_max: 235.1
homing_speed:50
homing_retract_dist:5
homing_positive_dir:false

[stepper_y]
step_pin:PB4
dir_pin:PB3
enable_pin:!PB5
microsteps: 64 #16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PB8
position_min: -0.5
position_endstop: 0 
position_max:235.1
homing_speed:50
homing_retract_dist:5
homing_positive_dir:false


[stepper_z]
step_pin:PC10
dir_pin:!PA15
enable_pin: !PC11
microsteps: 64 #16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop ## PB12 for Z-max; endstop have'!' is NO

##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##	Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop:-5
position_max: 268
position_min: -5
homing_speed: 8
homing_retract_dist: 5
second_homing_speed: 3

[extruder]
step_pin:PA5
dir_pin:!PA6
enable_pin:!PA4
microsteps: 64 #16
rotation_distance: 28.994 #29.0  #31.4	#Bondtech 5mm Drive Gears
gear_ratio: 52:10
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 310
heater_pin: PA7
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin: PA1
max_power: 1
#control :pid
#pid_kp : 26.213
#pid_ki : 1.304
#pid_kd : 131.721
pressure_advance: 0.022
pressure_advance_smooth_time: 0.04
instantaneous_corner_velocity: 2.5
max_extrude_only_distance: 300
max_extrude_only_velocity:60
max_extrude_only_accel:5000
max_extrude_cross_section: 9999999
min_extrude_temp:100

[verify_heater extruder]
max_error: 120
check_gain_time:30
hysteresis: 10
heating_gain: 2

[heater_bed]
heater_pin:PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
#control : pid
#pid_kp : 75.397
#pid_ki : 0.823
#pid_kd : 1727.531
pwm_cycle_time: 0.016
min_temp: 0
max_temp: 120


[verify_heater heater_bed]
max_error: 120
check_gain_time:30
hysteresis: 10
heating_gain: 2



[respond]
default_type: echo
default_prefix: echo:

[virtual_sdcard]
path: ~/gcode_files
on_error_gcode:  
    # test OK
    G91
    G1 Z25 F900
    G90
    TURN_OFF_HEATERS
    M106 S100
    M84
    M300 P10000 S1
    G4 P300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300

########################################
# PRINT_START/CANCEL_PRINT/PAUSE/RESUME/filament_switch_sensor
########################################

[print_stats]

[gcode_move]

    
[gcode_macro PRINT_START]         
gcode:
    SKEW_PROFILE LOAD=CaliFlower
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
	  G92 E0                                         
    BED_MESH_CLEAR                                     
	  G90             
    BED_MESH_CALIBRATE ADAPTIVE=1 METHOD=scan SCAN_MODE=rapid algorithm=bicubic #PROFILE=6          
    CLEAR_PAUSE
    M117 Printing                   
    
[gcode_macro PRINT_END]
gcode:
    SET_SKEW CLEAR=1
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    {% set RUN_CRUISE   = printer.configfile.settings['printer'].minimum_cruise_ratio|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} MINIMUM_CRUISE_RATIO={RUN_CRUISE}
    M220 S100
    M221 S100
    {% set z = params.Z|default(100)|int %} 
    {% if (printer.gcode_move.position.z+5) < z %}
      G90 
      G1 Z{z+5} F6000 
    {% endif %}
    TURN_OFF_HEATERS
    M107
    M84


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    {% set RUN_CRUISE   = printer.configfile.settings['printer'].minimum_cruise_ratio|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} MINIMUM_CRUISE_RATIO={RUN_CRUISE}
    {% set z = params.Z|default(100)|int %}  
    {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
    {% set y_park = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %} 
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} 
    SDCARD_RESET_FILE
    M220 S100
    M221 S100
    M400
    G91
    M83
    G1 E-10.0 F1200
    TURN_OFF_HEATERS
    M107
    {% if (printer.gcode_move.position.z+5) < z %}
    G90
    G0 X{x_park} Y{y_park} Z{z+5} F6000
    {% endif %}
    {%if (printer.gcode_move.position.z+5) >= z %}
    {%if (printer.gcode_move.position.z+5) < printer.toolhead.axis_maximum.z %}
    G91
    G1 Z5 F300
    G90
    G0 X{x_park} Y{y_park} F6000
    {% else %}
    G90
    G0 X{x_park} Y{y_park} Z{printer.toolhead.axis_maximum.z} F6000
    {% endif %}
    {% endif %}
    M84

[pause_resume]
recover_velocity: 50.0 

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    M400 
    {% set z = params.Z|default(30)|int %}                                                   
    {% set E = (params.E|default(2))|float %}
    {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
    {% set y_park = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %} 
                                                                                  
    {% if (printer.gcode_move.position.x) <= (x_park+1) and (printer.gcode_move.position.y) >= (y_park-1) %}
      M400 
    {% else %}
      {% set position = printer.gcode_move.gcode_position %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_x VALUE="{position.x}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_y VALUE="{position.y}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_z VALUE="{position.z}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_e VALUE="{position.e}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}   
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed_temp VALUE={printer['heater_bed'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed1_temp VALUE={printer['heater_generic heater_bed1'].target}
        SAVE_GCODE_STATE NAME=timelapse_state_a
        M83
        G91
      {% if (printer.gcode_move.position.z+5) <  printer.toolhead.axis_maximum.z  %} 
        G1 E-2 X3 Z1 F2100
        G1 Z4 F600
      {% endif %}
        SAVE_GCODE_STATE NAME=timelapse_state_b
        G90
      {% if (printer.gcode_move.position.z+5) < z %}
        G1 Z{z+5} X{x_park} Y{y_park} E-20 F6000 
      {% else %}
        G1 X{x_park} Y{y_park} E-20 F6000
      {% endif %}
        M400
        M25
        SET_IDLE_TIMEOUT TIMEOUT=1200
        M400
    {% endif %}
                                                           


[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_bed_temp: 0
variable_bed1_temp: 0
variable_saved_x: 0.0
variable_saved_y: 0.0
variable_saved_z: 0.0
variable_saved_e: 0.0
gcode:
    M24
    {% set e = params.E|default(2)|int %}   
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    {% if printer[printer.toolhead.extruder].temperature < etemp-4 %}   
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}   
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
      SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={bed1_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={etemp-4} MAXIMUM={etemp+10}   
    {% endif %} 
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}   
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={bed1_temp}
    M17 E
    G91
    M83
    G1 E100 F200	
    G4 P2000	
    G1 X20 F15000
    G1 X-20
    G1 X20
    G1 X-20
    G1 X20
    G1 X-20
    ;G1 E-2 F600
    G90
    G92 E{saved_e}
    RESTORE_GCODE_STATE NAME=timelapse_state_b MOVE=1 MOVE_SPEED=250
    RESTORE_GCODE_STATE NAME=timelapse_state_a MOVE=1 MOVE_SPEED=250 
    SAVE_GCODE_STATE NAME=timelapse_state_a
    SAVE_GCODE_STATE NAME=timelapse_state_b
    M400
    ;M24

[filament_switch_sensor fila]
pause_on_runout: True
runout_gcode:
    SET_FILAMENT_SENSOR SENSOR=fila ENABLE=1
    M118 ;Filament detection is triggered,please check.
insert_gcode:
event_delay: 3.0
pause_delay: 1.0
switch_pin: PA12

##############################################################


#fan for printed model FAN0
[fan]
pin: PC9

#fan for hotend FAN1
[heater_fan fan1]
pin: PA8
fan_speed: 0.4
shutdown_speed: 1

[printer]
kinematics:cartesian
max_velocity: 500
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 9.0

[input_shaper]
#shaper_type_x = ei
#shaper_freq_x = 79.2
#shaper_type_y = mzv
#shaper_freq_y = 48.2
#damping_ratio_x: 0.1
#damping_ratio_y: 0.1

####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################
[idle_timeout]
timeout: 3600
gcode:
  {% if printer[printer.toolhead.extruder].temperature > 140 %}   # Reduce the hot end temperature after 10 minutes
  {action_respond_info("Extruder powered down on idle timeout.")}
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={120}       # After pausing printing, reduce nozzle temperature to 50℃
  M84 E
  # SET_IDLE_TIMEOUT TIMEOUT=259200       # Timer duration 3 days.
  {% else %}
  TURN_OFF_HEATERS
  M84 E
  {% endif %}

[safe_z_home]
home_xy_position: 141.75,97.05
speed: 200
z_hop: 10                 
z_hop_speed: 5


[gcode_macro G29]
gcode:
      M400
      BED_MESH_CLEAR
      G28
      BED_MESH_CALIBRATE PROFILE=6 METHOD=scan SCAN_MODE=rapid algorithm=bicubic
      #BED_MESH_CALIBRATE profile=6 mesh_min=15,21 mesh_max=210,220 probe_count=6 algorithm=bicubic
      M400
      G4 P2000
      G91 
      G1 Z5 F300 
      G90
      G28 Z
      G1 X117.5 Y117.5 F12000
      G1 Z0 F300

#####################################################################
# 	Probe
#####################################################################

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_45474E621B0483CA-if00

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 100

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 1.0
#i2c_address:
i2c_mcu: eddy
i2c_bus: i2c0f
# x_offset: -24.25
# y_offset: 20.45
# new Probe values:
#Eddy 0Deg x=-36.16 y=31.66
x_offset: -36.16
y_offset: 31.66
data_rate: 500

[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 1
speed: 500
mesh_min:15,32           
mesh_max: 197.94, 203.44 #185,211 
probe_count: 21, 21
algorithm: bicubic

[safe_z_home]
home_xy_position: 141,98 
speed: 200
z_hop: 10                 
z_hop_speed: 25

[screws_tilt_adjust]
screw1_name: front left screw
screw1: 56.75, 12.05
screw2_name: rear left screw
screw2: 56.75, 182.05
screw3_name: rear right screw
screw3: 226.75, 182.05 
screw4_name: front right screw
screw4: 226.75, 12.05  
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4  # Use CW for Clockwise and CCW for Counter Clockwise

[skew_correction] 


#####################################################################
# BTT Eddy Helper Macros
#####################################################################
# This macro automates a lot of the frequency mapping process and simplifies the steps significantly.
[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}

[gcode_macro GET_BED_MESH]
gcode:
  BED_MESH_CLEAR
  G28
  BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid PROFILE=6
  BED_MESH_PROFILE LOAD="6"

# Uncomment this if you are using Eddy as the probe AND the homing endstop
[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}

# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro Z_OFFSET_APPLY_PROBE]
rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
gcode:
  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }

# Uncomment the lines in this macro if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
  {% if params.Z_ADJUST %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
  {% endif %}
  {% if params.Z %} 
    {% set paramList = rawparams.split() %}
    {% for i in range(paramList|length) %}
      {% if paramList[i]=="Z=0" %}
        {% set temp=paramList.pop(i) %}
        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
        {% if paramList.append(temp) %}{% endif %}
      {% endif %}
    {% endfor %}
    {% set rawparams=paramList|join(' ') %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }

#####################################################################
# LED Control
#####################################################################
# LED Control 1.0
[output_pin caselight]
pin: PB7
pwm: false
shutdown_value:0
value:0.0

[output_pin caselight1]
pin: PC7
pwm: false
shutdown_value:0
value:0.0

[gcode_macro FLASHLIGHT_ON]
description: Turn on Hotend LEDs
gcode:
  SET_PIN PIN=caselight VALUE=1


[gcode_macro FLASHLIGHT_OFF]
description: Turn off Hotend LEDs
gcode:
  SET_PIN PIN=caselight VALUE=0


[gcode_macro MODLELIGHT_ON]
description: Turn on Logo LEDs
gcode:
  SET_PIN PIN=caselight1 VALUE=1


[gcode_macro MODLELIGHT_OFF]
description: Turn off Logo LEDs
gcode:
  SET_PIN PIN=caselight1 VALUE=0

# LED Control 2.0
[gcode_macro FLASHLIGHT_SWITCH]
description: Switch Hotend LEDs
gcode:
  RUN_SHELL_COMMAND CMD=FLASHLIGHT

[gcode_shell_command FLASHLIGHT]
command: sh /home/mks/sled2.sh
timeout: 5.

[gcode_macro MODLELIGHT_SWITCH]
description: Switch Logo LEDs
gcode:
  RUN_SHELL_COMMAND CMD=MODLELIGHT

[gcode_shell_command MODLELIGHT]
command: sh /home/mks/sled1.sh
timeout: 5.



########################################
# TMC UART configuration
########################################

[tmc2209 stepper_x]
uart_pin: PB9
run_current: 1.0
hold_current: 0.8
interpolate: True
stealthchop_threshold:0

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 1.2
hold_current: 0.8
interpolate: True
stealthchop_threshold:0

[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.8
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2209 extruder]
uart_pin: PC4
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[mcu rpi]
serial: /tmp/klipper_host_mcu

#[adxl345]
#cs_pin: rpi:None
#spi_bus: spidev0.2

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    100, 100, 20  # an example


[force_move]
enable_force_move : true
   
[display_status]


[gcode_macro M17]
gcode:
  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
      #SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}



[gcode_macro M84]
rename_existing:M84.1
gcode:

  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}



[delayed_gcode KINEMATIC_POSITION]
initial_duration:3.0
gcode:
      SET_KINEMATIC_POSITION X=110
      SET_KINEMATIC_POSITION Y=110
      SET_KINEMATIC_POSITION Z=0


####################################################################
#	Configuration related to partition heating
#####################################################################
[heater_generic heater_bed1]
gcode_id:M105
heater_pin:PC8
max_power:1.0
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin:PC2
control: pid
pid_kp: 70.818
pid_ki: 0.637
pid_kd: 1967.864
pwm_cycle_time: 0.016
min_temp: 0
max_temp: 120

[verify_heater heater_bed1] 
max_error: 600 
check_gain_time:120 
hysteresis: 10    
heating_gain: 2 

[gcode_macro M191]
gcode:
      {% set s = (params.S|float,120)|min %}
      {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
        {% if printer.heater_bed.temperature <= s-2 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
        # G4 P20000
        # {% else %}
        # G4 P10000
        {% endif %}   
      {% else %}
      M140 S0
      {% endif %}   
	  
[gcode_macro M190]
rename_existing: M99190
gcode:
      {% set s = (params.S|float,120)|min %}
      {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
        {% if printer.heater_bed.temperature <= s-2 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
        # G4 P20000
        # {% else %}
        # G4 P10000
        {% endif %}   
      {% else %}
      M140 S0
      {% endif %} 
	   
[gcode_macro M140]
rename_existing: M99140
gcode:
      {% set s = (params.S|float,120)|min %}
	    {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
      {% else %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
      SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET=0
	    {% endif %} 

[gcode_macro M141]
gcode:
       {% set s = (params.S|float,120)|min %}
       {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
       {% else %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET=0
       {% endif %} 

#############################################################################
#   PID Tuning Macros
#############################################################################

[gcode_macro PID_Tune_EXTRUDER]
gcode:
  {% set temperature = params.TEMPERATURE|default(210) %}
  G28
  M106 S255
  PID_CALIBRATE HEATER=extruder TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
  M106 S255 ;Sets Print Fans to 100%
  PID_CALIBRATE HEATER=heater_bed TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_Outer_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
  M106 S255 ;Sets Print Fans to 100%
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={temperature} 	;Heats Inner Zone at the same time for better tuning 
  PID_CALIBRATE HEATER=heater_bed1 TARGET={temperature}
  SAVE_CONFIG   

####################################################################
## G-code macro definition
#####################################################################

[gcode_macro M205]
description: Sets square corner velocity.
  Usage: M205 [X<velocity>] [Y<velocity>]
gcode:
  {% set max_square_corner_velocity = 30 %}
  {% if 'X' in params or 'Y' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY="{(params.X|default(0)|float, params.Y|default(0)|float,max_square_corner_velocity)|min}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro M203]
description: Sets maximum velocity.
  Usage: M203 [X<velocity>] [Y<velocity>]
gcode:
  {% if 'X' in params or 'Y' in params %}
    {% set velocity = (params.X|default(params.Y)|float,
                       params.Y|default(params.X)|float,500)|min %}
    SET_VELOCITY_LIMIT VELOCITY="{velocity}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro m600]
description: Pauses the current print.
  Usage: M600 [B<beeps>] [E<pos>] [L<pos>] [R<temp>] [U<pos>] [X<pos>] [Y<pos>]
              [Z<pos>]
gcode:
  PAUSE P=2{% for k in params|select("in", "BEXYZ") %}{
      ' '~k~'="'~params[k]~'"'}{% endfor %}



################ Buzzer configuration ##################
[output_pin beeper]
pin: PA2
pwm: true
shutdown_value:0
value:0.0


[gcode_macro m300]
description: Emits and audible beep.
  Usage: M300 [P<duration>] [S<frequency>]
gcode:
  {% set settings = printer.configfile.settings %}
  {% if "output_pin beeper" in printer %}
    {% set P = (params.P|default(100)|int, 0)|max %}
    {% set S = (params.S|default(1000)|int, 10000)|min %}
    SET_PIN PIN=beeper VALUE={
        settings["output_pin beeper"].scale|default(1.0) * 0.5
      }{% if settings["output_pin beeper"].pwm %} CYCLE_TIME={
        1.0 / S }{% endif %}
    G4 P{P}
    SET_PIN PIN=beeper VALUE=0
  {% else %}
    {action_respond_info(
       "M300 is disabled. To enable create an [output_pin beeper] config.")}
  {% endif %}
  

[gcode_arcs]
resolution: 0.1

[exclude_object]

[gcode_macro PREHEAT_BED_PLA]
gcode:
  M190 S60

[gcode_macro PREHEAT_BED_PETG]
gcode:
  M190 S75

[include moonraker_obico_macros.cfg]
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3321967.844,0.100000:3320219.575,0.150000:3318508.827,
#*# 	0.200000:3316872.616,0.250000:3315288.365,0.300000:3313661.197,
#*# 	0.350000:3312107.361,0.400000:3310618.985,0.450000:3309118.273,
#*# 	0.500000:3307722.331,0.550000:3306338.323,0.600000:3305001.245,
#*# 	0.650000:3303656.279,0.700000:3302390.804,0.750000:3301136.497,
#*# 	0.800000:3300065.183,0.850000:3298783.297,0.900000:3297657.776,
#*# 	0.950000:3296567.857,1.000000:3295448.196,1.050000:3294386.029,
#*# 	1.100000:3293370.298,1.150000:3292342.040,1.200000:3291415.962,
#*# 	1.250000:3290445.665,1.300000:3289519.802,1.350000:3288626.816,
#*# 	1.400000:3287716.168,1.450000:3286837.657,1.500000:3285999.273,
#*# 	1.550000:3285179.996,1.600000:3284386.368,1.650000:3283612.957,
#*# 	1.700000:3282843.066,1.750000:3282111.344,1.800000:3281356.144,
#*# 	1.850000:3280674.546,1.900000:3279963.508,1.950000:3279306.530,
#*# 	2.000000:3278566.583,2.050000:3278027.630,2.100000:3277375.439,
#*# 	2.150000:3276784.792,2.200000:3276151.329,2.250000:3275621.300,
#*# 	2.300000:3275028.997,2.350000:3274487.634,2.400000:3274077.979,
#*# 	2.450000:3273440.813,2.500000:3272912.790,2.550000:3272391.676,
#*# 	2.600000:3271884.837,2.650000:3271404.711,2.700000:3270928.716,
#*# 	2.750000:3270488.168,2.800000:3270026.403,2.850000:3269587.728,
#*# 	2.900000:3269160.148,2.950000:3268736.556,3.000000:3268312.976,
#*# 	3.050000:3267926.791,3.100000:3267511.559,3.150000:3267134.979,
#*# 	3.200000:3266743.314,3.250000:3266397.047,3.300000:3266040.505,
#*# 	3.350000:3265691.309,3.400000:3265360.718,3.450000:3265010.087,
#*# 	3.500000:3264686.659,3.550000:3264361.868,3.600000:3264057.292,
#*# 	3.650000:3263744.670,3.700000:3263435.130,3.750000:3263142.349,
#*# 	3.800000:3262839.047,3.850000:3262571.550,3.900000:3262329.987,
#*# 	3.950000:3262039.416,4.000000:3261754.194,4.050000:3261490.167
#*# calibration_temp = 46.885409
#*# drift_calibration =
#*# 	3343093.324308, -833.790465, 5.677046
#*# 	3320436.695419, -540.016374, 3.183340
#*# 	3304383.518345, -360.755283, 1.702269
#*# 	3291735.080173, -215.956577, 0.527407
#*# 	3282525.942456, -134.022380, -0.049928
#*# 	3274970.147376, -56.715629, -0.643742
#*# 	3267902.296582, 52.314906, -1.620363
#*# 	3264590.766569, 42.169246, -1.414315
#*# 	3260422.598874, 96.317146, -1.891335
#*# drift_calibration_min_temp = 40.4087603294
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.703
#*# pid_ki = 2.754
#*# pid_kd = 479.842
#*#
#*# [heater_bed1]
#*# control = pid
#*# pid_kp = 70.818
#*# pid_ki = 0.637
#*# pid_kd = 1967.864
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.00330977477358
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 79.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 48.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.344
#*# pid_ki = 0.860
#*# pid_kd = 108.811
#*#
#*# [bed_mesh 6]
#*# version = 1
#*# points =
#*# 	0.011082, 0.013442, 0.011885, 0.007660, 0.002498, 0.001073, 0.002915, -0.004389, 0.001570, -0.001464, -0.000344, -0.002006, 0.004929, -0.001710, 0.002488, 0.004292, 0.006244, -0.001331, -0.003417, -0.003539, 0.007665
#*# 	0.021422, 0.011322, 0.013279, 0.006590, 0.005563, 0.003702, -0.004990, -0.003000, 0.002630, -0.004579, 0.001347, 0.001282, -0.004643, -0.001664, -0.003679, -0.007699, -0.009445, -0.018440, -0.018739, -0.017818, -0.009875
#*# 	0.013134, 0.006291, 0.004339, -0.002069, -0.001588, -0.006348, -0.003064, 0.000349, -0.000020, -0.002479, -0.002652, -0.000584, -0.002389, -0.006506, -0.005065, -0.011965, -0.006591, -0.018135, -0.014055, -0.014404, -0.000799
#*# 	0.007663, 0.008678, -0.001129, 0.000289, -0.007099, -0.007373, -0.011141, -0.004256, 0.001954, 0.003251, 0.001340, 0.000180, 0.001148, -0.000463, -0.000838, -0.011052, -0.008216, -0.012969, -0.010430, -0.010306, 0.003898
#*# 	0.007437, 0.010552, 0.001872, -0.004550, -0.009898, -0.009235, -0.005942, 0.003647, 0.003275, 0.000469, 0.008537, 0.007083, -0.000985, -0.005544, -0.003690, -0.007460, -0.012461, -0.018258, -0.020522, -0.010894, 0.006731
#*# 	0.016249, 0.021397, 0.007641, 0.007658, 0.000578, 0.000490, -0.000169, 0.006324, 0.011271, 0.017928, 0.012452, 0.009878, 0.012665, 0.008746, 0.008417, -0.002325, -0.013199, -0.012975, -0.013820, -0.007700, 0.005552
#*# 	0.033814, 0.021499, 0.019516, 0.010498, 0.004971, 0.010238, 0.018926, 0.015288, 0.025698, 0.024354, 0.020470, 0.024438, 0.020143, 0.007671, 0.002589, 0.001645, -0.006620, -0.016237, -0.010016, -0.004916, 0.014480
#*# 	0.040382, 0.036070, 0.025534, 0.016235, 0.011840, 0.009528, 0.013070, 0.018072, 0.023549, 0.026239, 0.026665, 0.025156, 0.020908, 0.020318, 0.007723, -0.000167, -0.009692, -0.015464, -0.008542, -0.000976, 0.006217
#*# 	0.040444, 0.028936, 0.022916, 0.012250, 0.009017, 0.009656, 0.010904, 0.022187, 0.024926, 0.021433, 0.022072, 0.027123, 0.010197, 0.008756, 0.006560, -0.006399, -0.006784, -0.016066, -0.021740, -0.010622, 0.004931
#*# 	0.047670, 0.036210, 0.025207, 0.013713, 0.010810, 0.004552, 0.009678, 0.017631, 0.021550, 0.022133, 0.020478, 0.016772, 0.013065, 0.008113, 0.001705, -0.011585, -0.006864, -0.010117, -0.014820, -0.012605, 0.001058
#*# 	0.048599, 0.036463, 0.025884, 0.018734, 0.006619, 0.005791, 0.010798, 0.019654, 0.025086, 0.020818, 0.020276, 0.013570, 0.009041, 0.000241, -0.009359, -0.008742, -0.008687, -0.017396, -0.017345, -0.011524, -0.004857
#*# 	0.054730, 0.045910, 0.034443, 0.022899, 0.013929, 0.020160, 0.012322, 0.022095, 0.028376, 0.022833, 0.021931, 0.018438, 0.008829, 0.004775, 0.004095, -0.003746, -0.003771, -0.015309, -0.011228, -0.013493, -0.000340
#*# 	0.060913, 0.050957, 0.041485, 0.027365, 0.018773, 0.018231, 0.023283, 0.027579, 0.027087, 0.023332, 0.023003, 0.019071, 0.018280, 0.009687, 0.005129, -0.000967, -0.005743, -0.008455, -0.010845, -0.005917, -0.001387
#*# 	0.065901, 0.055689, 0.049516, 0.033734, 0.034375, 0.028896, 0.027764, 0.033193, 0.032111, 0.032373, 0.025123, 0.027321, 0.018775, 0.020120, 0.017855, 0.013296, 0.007491, 0.007982, 0.005035, -0.000484, 0.007061
#*# 	0.058910, 0.053604, 0.053669, 0.036006, 0.031332, 0.028379, 0.029396, 0.033267, 0.028594, 0.030785, 0.026275, 0.028899, 0.025356, 0.027128, 0.021437, 0.012088, 0.012299, -0.000279, -0.005179, 0.004640, 0.010147
#*# 	0.058220, 0.052378, 0.049109, 0.037216, 0.035051, 0.033870, 0.027588, 0.026736, 0.030065, 0.030917, 0.028393, 0.025063, 0.022817, 0.023997, 0.024899, 0.017339, 0.007078, 0.003804, 0.003667, 0.001079, 0.010030
#*# 	0.061972, 0.048911, 0.048091, 0.038047, 0.032242, 0.028650, 0.030257, 0.032291, 0.029830, 0.028486, 0.026813, 0.025748, 0.026715, 0.019236, 0.014858, 0.017665, 0.009981, -0.000619, -0.000093, 0.004397, -0.000933
#*# 	0.044023, 0.045499, 0.043677, 0.038512, 0.038888, 0.036149, 0.030244, 0.026734, 0.027930, 0.028145, 0.029334, 0.022630, 0.020791, 0.021285, 0.027354, 0.014034, 0.006599, 0.004848, 0.005640, 0.000651, 0.005029
#*# 	0.039408, 0.027965, 0.035717, 0.022865, 0.022700, 0.023242, 0.030917, 0.021738, 0.020229, 0.021458, 0.018835, 0.019803, 0.018670, 0.011324, 0.015670, 0.007075, 0.007980, -0.001313, 0.001977, 0.002455, 0.001498
#*# 	0.025605, 0.026902, 0.020389, 0.017436, 0.021619, 0.020105, 0.013872, 0.013068, 0.014298, 0.020744, 0.018761, 0.013823, 0.013823, 0.018876, 0.018170, 0.008983, 0.008983, 0.007871, 0.007118, 0.002939, 0.004360
#*# 	0.016730, 0.012825, 0.012466, 0.008159, 0.004011, 0.010908, 0.012989, 0.011005, 0.010792, 0.009824, 0.003377, 0.013154, 0.011430, 0.010275, 0.013276, 0.006839, 0.010316, 0.000505, -0.003748, -0.003058, -0.001982
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = bicubic
#*# y_count = 21
#*# mesh_y_pps = 2
#*# min_y = 32.0
#*# x_count = 21
#*# max_y = 203.4
#*# mesh_x_pps = 2
#*# max_x = 197.8
