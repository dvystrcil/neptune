####################################################################################
# Machine type: NEPTUNE 4 PRO
# Current configuration version: V1.4
# Dateï¼š2023-12-1
####################################################################################
# This product (Neptune 4/4pro/4plus/4max) adopts Klipper firmware 
# and does not support users to update the official klipper/fluidd
# /moonraker by themselves, otherwise the machine will not work properly.
# If you want to DIY and are an expert or interested in this field, 
# we recommend that you prepare your own tools for burning images so 
# that you can restore them if problems arise. Please contact after-sales 
# support team for tutorials on burning images. Thank you for your cooperation!
####################################################################################
# This file contains common pin mappings for ZNP-K1-V1.0 
# boards. To use this config, the firmware should be compiled for the
# STM32F402. When running "make menuconfig", enable "extra low-level
# configuration setup", select the 32KiB bootloader, and serial (on
# USART1 PA10/PA9) communication.

# The "make flash" command does not work on the ZN-K1-V1.0. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "elegoo_k1.bin" on an SD card and then restart the ZNP-K1-V1.0
# with that SD card.

# See docs/Config_Reference.md for a description of parameters.
####################################################################################


[include plr.cfg]

[include neptune4pro_autotune.cfg]

#[include adxlmcu.cfg]

[mcu]
# The hardware use USART1 PA10/PA9 connect to RK3328
serial: /dev/ttyS0
restart_method: command

[stepper_x]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PC0
position_min: -8.5  
position_endstop:-8
position_max: 235.1
homing_speed:50
homing_retract_dist:5
homing_positive_dir:false

[stepper_y]
step_pin:PB4
dir_pin:PB3
enable_pin:!PB5
microsteps: 16
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PB8
position_min: -0.5
position_endstop: 0 
position_max:235.1
homing_speed:50
homing_retract_dist:5
homing_positive_dir:false


[stepper_z]
step_pin:PC10
dir_pin:!PA15
enable_pin: !PC11
microsteps: 32 #16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop ## PB12 for Z-max; endstop have'!' is NO

##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##	Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
#position_endstop:-5
position_max: 268
position_min: -12
homing_speed: 8
homing_retract_dist: 5
second_homing_speed: 3

[extruder]
step_pin:PA5
dir_pin:!PA6
enable_pin:!PA4
microsteps: 64 #16
rotation_distance: 28.994 #29.0  #31.4	#Bondtech 5mm Drive Gears
gear_ratio: 52:10
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 310
heater_pin: PA7
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin: PA1
max_power: 1
#control :pid
#pid_kp : 26.213
#pid_ki : 1.304
#pid_kd : 131.721
pressure_advance: 0.022
pressure_advance_smooth_time: 0.04
instantaneous_corner_velocity: 2.5
max_extrude_only_distance: 300
max_extrude_only_velocity:60
max_extrude_only_accel:5000
max_extrude_cross_section: 9999999
min_extrude_temp:100

[verify_heater extruder]
max_error: 120
check_gain_time:30
hysteresis: 10
heating_gain: 2

[heater_bed]
heater_pin:PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
#control : pid
#pid_kp : 75.397
#pid_ki : 0.823
#pid_kd : 1727.531
pwm_cycle_time: 0.016
min_temp: 0
max_temp: 120


[verify_heater heater_bed]
max_error: 120
check_gain_time:30
hysteresis: 10
heating_gain: 2



[respond]
default_type: echo
default_prefix: echo:

[virtual_sdcard]
path: ~/gcode_files
on_error_gcode:  
    # test OK
    G91
    G1 Z25 F900
    G90
    TURN_OFF_HEATERS
    M106 S100
    M84
    M300 P10000 S1
    G4 P300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300
    M300

########################################
# PRINT_START/CANCEL_PRINT/PAUSE/RESUME/filament_switch_sensor
########################################

[print_stats]

[gcode_move]

    
[gcode_macro PRINT_START]         
gcode:
    SKEW_PROFILE LOAD=CaliFlower
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
	  G92 E0   
    BED_MESH_CLEAR                                     
	  G90    
    PREHEAT_BED_PLA #set the bed tempature to 60         
    BED_MESH_CALIBRATE ADAPTIVE=1 METHOD=rapid_scan algorithm=bicubic           
    CLEAR_PAUSE
    M117 Printing                   
    
[gcode_macro PRINT_END]
gcode:
    SET_SKEW CLEAR=1
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    {% set RUN_CRUISE   = printer.configfile.settings['printer'].minimum_cruise_ratio|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} MINIMUM_CRUISE_RATIO={RUN_CRUISE}
    M220 S100
    M221 S100
    {% set z = params.Z|default(100)|int %} 
    {% if (printer.gcode_move.position.z+5) < z %}
      G90 
      G1 Z{z+5} F6000 
    {% endif %}
    TURN_OFF_HEATERS
    M107
    M84


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    {% set RUN_CRUISE   = printer.configfile.settings['printer'].minimum_cruise_ratio|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} MINIMUM_CRUISE_RATIO={RUN_CRUISE}
    {% set z = params.Z|default(100)|int %}  
    {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
    {% set y_park = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %} 
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} 
    SDCARD_RESET_FILE
    M220 S100
    M221 S100
    M400
    G91
    M83
    G1 E-10.0 F1200
    TURN_OFF_HEATERS
    M107
    {% if (printer.gcode_move.position.z+5) < z %}
    G90
    G0 X{x_park} Y{y_park} Z{z+5} F6000
    {% endif %}
    {%if (printer.gcode_move.position.z+5) >= z %}
    {%if (printer.gcode_move.position.z+5) < printer.toolhead.axis_maximum.z %}
    G91
    G1 Z5 F300
    G90
    G0 X{x_park} Y{y_park} F6000
    {% else %}
    G90
    G0 X{x_park} Y{y_park} Z{printer.toolhead.axis_maximum.z} F6000
    {% endif %}
    {% endif %}
    M84

[pause_resume]
recover_velocity: 50.0 

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    M400 
    {% set z = params.Z|default(30)|int %}                                                   
    {% set E = (params.E|default(2))|float %}
    {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
    {% set y_park = params.Y|default(printer.toolhead.axis_maximum.y-5)|int %} 
                                                                                  
    {% if (printer.gcode_move.position.x) <= (x_park+1) and (printer.gcode_move.position.y) >= (y_park-1) %}
      M400 
    {% else %}
      {% set position = printer.gcode_move.gcode_position %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_x VALUE="{position.x}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_y VALUE="{position.y}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_z VALUE="{position.z}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_e VALUE="{position.e}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}   
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed_temp VALUE={printer['heater_bed'].target}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed1_temp VALUE={printer['heater_generic heater_bed1'].target}
        SAVE_GCODE_STATE NAME=timelapse_state_a
        M83
        G91
      {% if (printer.gcode_move.position.z+5) <  printer.toolhead.axis_maximum.z  %} 
        G1 E-2 X3 Z1 F2100
        G1 Z4 F600
      {% endif %}
        SAVE_GCODE_STATE NAME=timelapse_state_b
        G90
      {% if (printer.gcode_move.position.z+5) < z %}
        G1 Z{z+5} X{x_park} Y{y_park} E-20 F6000 
      {% else %}
        G1 X{x_park} Y{y_park} E-20 F6000
      {% endif %}
        M400
        M25
        SET_IDLE_TIMEOUT TIMEOUT=1200
        M400
    {% endif %}
                                                           


[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_bed_temp: 0
variable_bed1_temp: 0
variable_saved_x: 0.0
variable_saved_y: 0.0
variable_saved_z: 0.0
variable_saved_e: 0.0
gcode:
    M24
    {% set e = params.E|default(2)|int %}   
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
    {% if printer[printer.toolhead.extruder].temperature < etemp-4 %}   
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}   
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
      SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={bed1_temp}
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={etemp-4} MAXIMUM={etemp+10}   
    {% endif %} 
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}   
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={bed1_temp}
    M17 E
    G91
    M83
    G1 E100 F200	
    G4 P2000	
    G1 X20 F15000
    G1 X-20
    G1 X20
    G1 X-20
    G1 X20
    G1 X-20
    ;G1 E-2 F600
    G90
    G92 E{saved_e}
    RESTORE_GCODE_STATE NAME=timelapse_state_b MOVE=1 MOVE_SPEED=250
    RESTORE_GCODE_STATE NAME=timelapse_state_a MOVE=1 MOVE_SPEED=250 
    SAVE_GCODE_STATE NAME=timelapse_state_a
    SAVE_GCODE_STATE NAME=timelapse_state_b
    M400
    ;M24

[filament_switch_sensor fila]
pause_on_runout: True
runout_gcode:
    SET_FILAMENT_SENSOR SENSOR=fila ENABLE=1
    M118 ;Filament detection is triggered,please check.
insert_gcode:
event_delay: 3.0
pause_delay: 1.0
switch_pin: PA12

##############################################################


#fan for printed model FAN0
[fan]
pin: PC9

#fan for hotend FAN1
[heater_fan fan1]
pin: PA8
fan_speed: 0.4
shutdown_speed: 1

[printer]
kinematics:cartesian
max_velocity: 500
max_accel: 5000
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 9.0

[input_shaper]
#shaper_type_x = ei
#shaper_freq_x = 79.2
#shaper_type_y = mzv
#shaper_freq_y = 48.2
#damping_ratio_x: 0.1
#damping_ratio_y: 0.1

####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################
[idle_timeout]
timeout: 3600
gcode:
  {% if printer[printer.toolhead.extruder].temperature > 140 %}   # Reduce the hot end temperature after 10 minutes
  {action_respond_info("Extruder powered down on idle timeout.")}
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={120}       # After pausing printing, reduce nozzle temperature to 50â„ƒ
  M84 E
  # SET_IDLE_TIMEOUT TIMEOUT=259200       # Timer duration 3 days.
  {% else %}
  TURN_OFF_HEATERS
  M84 E
  {% endif %}

[safe_z_home]
home_xy_position: 141.75,97.05
speed: 200
z_hop: 10                 
z_hop_speed: 25


[gcode_macro G29]
gcode:
      M400
      BED_MESH_CLEAR
      G28
      PREHEAT_BED_PLA
      BED_MESH_CALIBRATE PROFILE=6 SCAN_MODE=rapid algorithm=bicubic
      #BED_MESH_CALIBRATE profile=6 mesh_min=15,21 mesh_max=210,220 probe_count=6 algorithm=bicubic
      M400
      G4 P2000
      G91 
      G1 Z5 F300 
      G90
      G28 Z
      G1 X117.5 Y117.5 F12000
      G1 Z0 F300

#####################################################################
# 	Probe
#####################################################################

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_45474E621B0483CA-if00
restart_method: command

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 100

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 1.0
#i2c_address:
i2c_mcu: eddy
i2c_bus: i2c0f
x_offset: -36.16
y_offset: 31.66

[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 1
speed: 500
mesh_min:15,32          
mesh_max: 197.94, 203.44 #185,211 
probe_count: 21, 21
algorithm: bicubic

[force_move]
enable_force_move: True

[save_variables]
filename: ~/printer_data/config/variables.cfg

[delayed_gcode RESTORE_PROBE_OFFSET]
initial_duration: 1.
gcode:
 {% set svv = printer.save_variables.variables %}
 {% if not printer["gcode_macro SET_GCODE_OFFSET"].restored %}
   SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ svv.nvm_offset|default(0) }
   SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=restored VALUE=True
 {% endif %}

[gcode_macro G28]
rename_existing: G28.1
gcode:
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
    SET_Z_FROM_PROBE
  {% endif %}

[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}
    G90
    G1 Z{cf.safe_z_home.z_hop}

# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro Z_OFFSET_APPLY_PROBE]
rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
gcode:
  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }

# Uncomment the lines in this macro if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
  {% if params.Z_ADJUST %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
  {% endif %}
  {% if params.Z %} 
    {% set paramList = rawparams.split() %}
    {% for i in range(paramList|length) %}
      {% if paramList[i]=="Z=0" %}
        {% set temp=paramList.pop(i) %}
        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
        {% if paramList.append(temp) %}{% endif %}
      {% endif %}
    {% endfor %}
    {% set rawparams=paramList|join(' ') %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }

# This macro automates a lot of the frequency mapping process and simplifies the steps significantly.
[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G90 # Abs positioning
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}

[gcode_macro GET_BED_MESH]
gcode:
  BED_MESH_CLEAR
  G28
  BED_MESH_CALIBRATE METHOD=rapid_scan PROFILE=6
  BED_MESH_PROFILE LOAD="6"

#This macro is optional but useful if you want to run a rapid scan before each print. Simply uncomment it and add BED_MESH_SCAN to your print start code.
#[gcode_macro BED_MESH_CALIBRATE]
#rename_existing: BTT_BED_MESH_CALIBRATE
#gcode:
#  SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=True #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg
#  BTT_BED_MESH_CALIBRATE METHOD=rapid_scan
#  SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg

[screws_tilt_adjust]
screw1_name: front left screw
screw1: 56.75, 12.05
screw2_name: rear left screw
screw2: 56.75, 182.05
screw3_name: rear right screw
screw3: 226.75, 182.05 
screw4_name: front right screw
screw4: 226.75, 12.05  
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4  # Use CW for Clockwise and CCW for Counter Clockwise

[skew_correction] 

#####################################################################
# LED Control
#####################################################################
# LED Control 1.0
[output_pin caselight]
pin: PB7
pwm: false
shutdown_value:0
value:0.0

[output_pin caselight1]
pin: PC7
pwm: false
shutdown_value:0
value:0.0

[gcode_macro FLASHLIGHT_ON]
description: Turn on Hotend LEDs
gcode:
  SET_PIN PIN=caselight VALUE=1


[gcode_macro FLASHLIGHT_OFF]
description: Turn off Hotend LEDs
gcode:
  SET_PIN PIN=caselight VALUE=0


[gcode_macro MODLELIGHT_ON]
description: Turn on Logo LEDs
gcode:
  SET_PIN PIN=caselight1 VALUE=1


[gcode_macro MODLELIGHT_OFF]
description: Turn off Logo LEDs
gcode:
  SET_PIN PIN=caselight1 VALUE=0

# LED Control 2.0
[gcode_macro FLASHLIGHT_SWITCH]
description: Switch Hotend LEDs
gcode:
  RUN_SHELL_COMMAND CMD=FLASHLIGHT

[gcode_shell_command FLASHLIGHT]
command: sh /home/mks/sled2.sh
timeout: 5.

[gcode_macro MODLELIGHT_SWITCH]
description: Switch Logo LEDs
gcode:
  RUN_SHELL_COMMAND CMD=MODLELIGHT

[gcode_shell_command MODLELIGHT]
command: sh /home/mks/sled1.sh
timeout: 5.

########################################
# TMC UART configuration
########################################

[tmc2209 stepper_x]
uart_pin: PB9
run_current: 1.0
hold_current: 0.8
interpolate: True
stealthchop_threshold:0

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 1.2
hold_current: 0.8
interpolate: True
stealthchop_threshold:0

[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.8
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[tmc2209 extruder]
uart_pin: PC4
run_current: 0.7
hold_current: 0.5
interpolate: True
stealthchop_threshold: 0

[mcu rpi]
serial: /tmp/klipper_host_mcu

#[adxl345]
#cs_pin: rpi:None
#spi_bus: spidev0.2

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#    100, 100, 20  # an example


[force_move]
enable_force_move : true
   
[display_status]


[gcode_macro M17]
gcode:
  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
      #SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}



[gcode_macro M84]
rename_existing:M84.1
gcode:

  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}



[delayed_gcode KINEMATIC_POSITION]
initial_duration:3.0
gcode:
      SET_KINEMATIC_POSITION X=110
      SET_KINEMATIC_POSITION Y=110
      SET_KINEMATIC_POSITION Z=0


####################################################################
#	Configuration related to partition heating
#####################################################################
[heater_generic heater_bed1]
gcode_id:M105
heater_pin:PC8
max_power:1.0
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin:PC2
control: pid
pid_kp: 70.818
pid_ki: 0.637
pid_kd: 1967.864
pwm_cycle_time: 0.016
min_temp: 0
max_temp: 120

[verify_heater heater_bed1] 
max_error: 600 
check_gain_time:120 
hysteresis: 10    
heating_gain: 2 

[gcode_macro M191]
gcode:
      {% set s = (params.S|float,120)|min %}
      {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
        {% if printer.heater_bed.temperature <= s-2 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
        # G4 P20000
        # {% else %}
        # G4 P10000
        {% endif %}   
      {% else %}
      M140 S0
      {% endif %}   
	  
[gcode_macro M190]
rename_existing: M99190
gcode:
      {% set s = (params.S|float,120)|min %}
      {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
        {% if printer.heater_bed.temperature <= s-2 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+10}
        # G4 P20000
        # {% else %}
        # G4 P10000
        {% endif %}   
      {% else %}
      M140 S0
      {% endif %} 
	   
[gcode_macro M140]
rename_existing: M99140
gcode:
      {% set s = (params.S|float,120)|min %}
	    {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={s|int}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
      {% else %}
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
      SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET=0
	    {% endif %} 

[gcode_macro M141]
gcode:
       {% set s = (params.S|float,120)|min %}
       {% if params.S is defined %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET={s|int}
       {% else %}
        SET_HEATER_TEMPERATURE HEATER=heater_bed1 TARGET=0
       {% endif %} 

#############################################################################
#   PID Tuning Macros
#############################################################################

[gcode_macro PID_Tune_EXTRUDER]
gcode:
  {% set temperature = params.TEMPERATURE|default(210) %}
  G28
  M106 S255
  PID_CALIBRATE HEATER=extruder TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
  M106 S255 ;Sets Print Fans to 100%
  PID_CALIBRATE HEATER=heater_bed TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_Outer_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  G28
  M106 S255 ;Sets Print Fans to 100%
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={temperature} 	;Heats Inner Zone at the same time for better tuning 
  PID_CALIBRATE HEATER=heater_bed1 TARGET={temperature}
  SAVE_CONFIG   

####################################################################
## G-code macro definition
#####################################################################

[gcode_macro M205]
description: Sets square corner velocity.
  Usage: M205 [X<velocity>] [Y<velocity>]
gcode:
  {% set max_square_corner_velocity = 30 %}
  {% if 'X' in params or 'Y' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY="{(params.X|default(0)|float, params.Y|default(0)|float,max_square_corner_velocity)|min}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro M203]
description: Sets maximum velocity.
  Usage: M203 [X<velocity>] [Y<velocity>]
gcode:
  {% if 'X' in params or 'Y' in params %}
    {% set velocity = (params.X|default(params.Y)|float,
                       params.Y|default(params.X)|float,500)|min %}
    SET_VELOCITY_LIMIT VELOCITY="{velocity}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro m600]
description: Pauses the current print.
  Usage: M600 [B<beeps>] [E<pos>] [L<pos>] [R<temp>] [U<pos>] [X<pos>] [Y<pos>]
              [Z<pos>]
gcode:
  PAUSE P=2{% for k in params|select("in", "BEXYZ") %}{
      ' '~k~'="'~params[k]~'"'}{% endfor %}



################ Buzzer configuration ##################
[output_pin beeper]
pin: PA2
pwm: true
shutdown_value:0
value:0.0


[gcode_macro m300]
description: Emits and audible beep.
  Usage: M300 [P<duration>] [S<frequency>]
gcode:
  {% set settings = printer.configfile.settings %}
  {% if "output_pin beeper" in printer %}
    {% set P = (params.P|default(100)|int, 0)|max %}
    {% set S = (params.S|default(1000)|int, 10000)|min %}
    SET_PIN PIN=beeper VALUE={
        settings["output_pin beeper"].scale|default(1.0) * 0.5
      }{% if settings["output_pin beeper"].pwm %} CYCLE_TIME={
        1.0 / S }{% endif %}
    G4 P{P}
    SET_PIN PIN=beeper VALUE=0
  {% else %}
    {action_respond_info(
       "M300 is disabled. To enable create an [output_pin beeper] config.")}
  {% endif %}
  

[gcode_arcs]
resolution: 0.1

[exclude_object]

[gcode_macro PREHEAT_BED_PLA]
gcode:
  M190 S60

[gcode_macro PREHEAT_BED_PETG]
gcode:
  M190 S75

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3312004.365,0.090000:3310888.821,0.130000:3309733.490,
#*# 	0.170000:3308544.145,0.210000:3307414.096,0.250000:3306326.205,
#*# 	0.290000:3305251.604,0.330000:3304189.442,0.370000:3303136.263,
#*# 	0.410000:3302130.196,0.450000:3301149.611,0.490000:3300178.501,
#*# 	0.530000:3299232.373,0.570000:3298289.022,0.610000:3297382.839,
#*# 	0.650000:3296465.434,0.690000:3295559.872,0.730000:3294741.712,
#*# 	0.770000:3293905.472,0.810000:3293095.012,0.850000:3292266.115,
#*# 	0.890000:3291505.221,0.930000:3290712.887,0.970000:3289972.620,
#*# 	1.010000:3289211.612,1.050000:3288490.489,1.090000:3287765.066,
#*# 	1.130000:3287066.724,1.170000:3286357.543,1.210000:3285718.796,
#*# 	1.250000:3285046.721,1.290000:3284415.934,1.330000:3283770.256,
#*# 	1.370000:3283140.816,1.410000:3282522.710,1.450000:3281932.218,
#*# 	1.490000:3281354.839,1.530000:3280783.517,1.570000:3280205.235,
#*# 	1.610000:3279676.282,1.650000:3279113.025,1.690000:3278599.897,
#*# 	1.730000:3278068.990,1.770000:3277547.851,1.810000:3277068.711,
#*# 	1.850000:3276591.582,1.890000:3276100.470,1.930000:3275606.533,
#*# 	1.970000:3275165.255,2.010000:3274714.340,2.050000:3274252.247,
#*# 	2.090000:3273826.384,2.130000:3273418.792,2.170000:3272977.035,
#*# 	2.210000:3272546.479,2.250000:3272174.814,2.290000:3271754.317,
#*# 	2.330000:3271391.503,2.370000:3270967.891,2.410000:3270617.164,
#*# 	2.450000:3270235.699,2.490000:3269890.871,2.530000:3269543.551,
#*# 	2.570000:3269182.581,2.610000:3268842.162,2.650000:3268516.443,
#*# 	2.690000:3268185.868,2.730000:3267855.490,2.770000:3267529.275,
#*# 	2.810000:3267235.251,2.850000:3266898.894,2.890000:3266621.943,
#*# 	2.930000:3266317.783,2.970000:3266040.444,3.010000:3265766.462,
#*# 	3.050000:3265462.194,3.090000:3265212.948,3.130000:3264883.014,
#*# 	3.170000:3264644.706,3.210000:3264439.832,3.250000:3264140.064,
#*# 	3.290000:3263911.983,3.330000:3263632.400,3.370000:3263406.277,
#*# 	3.410000:3263184.507,3.450000:3262929.579,3.490000:3262692.021,
#*# 	3.530000:3262454.569,3.570000:3262248.766,3.610000:3262029.147,
#*# 	3.650000:3261816.777,3.690000:3261608.608,3.730000:3261398.405,
#*# 	3.770000:3261190.427,3.810000:3260981.407,3.850000:3260798.104,
#*# 	3.890000:3260577.221,3.930000:3260399.044,3.970000:3260207.454,
#*# 	4.010000:3260032.950,4.050000:3259835.994
#*# calibration_temp = 46.885409
#*# drift_calibration =
#*# 	3343093.324308, -833.790465, 5.677046
#*# 	3320436.695419, -540.016374, 3.183340
#*# 	3304383.518345, -360.755283, 1.702269
#*# 	3291735.080173, -215.956577, 0.527407
#*# 	3282525.942456, -134.022380, -0.049928
#*# 	3274970.147376, -56.715629, -0.643742
#*# 	3267902.296582, 52.314906, -1.620363
#*# 	3264590.766569, 42.169246, -1.414315
#*# 	3260422.598874, 96.317146, -1.891335
#*# drift_calibration_min_temp = 40.4087603294
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 72.703
#*# pid_ki = 2.754
#*# pid_kd = 479.842
#*#
#*# [heater_bed1]
#*# control = pid
#*# pid_kp = 70.818
#*# pid_ki = 0.637
#*# pid_kd = 1967.864
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.00330977477358
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 79.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 48.2
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.344
#*# pid_ki = 0.860
#*# pid_kd = 108.811
#*#
#*# [bed_mesh 6]
#*# version = 1
#*# points =
#*# 	0.021699, 0.024845, 0.016072, 0.015301, 0.013259, 0.006389, 0.005648, 0.009454, 0.007133, 0.011771, 0.010608, 0.005331, 0.000862, -0.006393, -0.000060, -0.000140, -0.009556, -0.021649, -0.015138, -0.013626, -0.004472
#*# 	0.023182, 0.022627, 0.018327, 0.011929, 0.008328, 0.007074, 0.005016, -0.000439, 0.003150, 0.006892, 0.011910, 0.000651, -0.000724, -0.013259, -0.017330, -0.013725, -0.016283, -0.020643, -0.022989, -0.035468, -0.015938
#*# 	0.016287, 0.015457, 0.011682, 0.005370, 0.001233, -0.004370, -0.008873, -0.000633, 0.009946, 0.014913, 0.006141, -0.001324, -0.007828, -0.011548, -0.013409, -0.021723, -0.029106, -0.031839, -0.029062, -0.021270, -0.016968
#*# 	0.015105, 0.009468, 0.005424, 0.000734, -0.008061, -0.009515, -0.007538, 0.002690, 0.005941, 0.013218, 0.010498, 0.009836, -0.000800, -0.003818, -0.015522, -0.015599, -0.015909, -0.024583, -0.028015, -0.028653, -0.027257
#*# 	0.023819, 0.007892, 0.002279, 0.000930, -0.002771, -0.009247, -0.008026, 0.000633, 0.018462, 0.015869, 0.007432, 0.000338, -0.003089, -0.013092, -0.013499, -0.023439, -0.024485, -0.032624, -0.028844, -0.020823, -0.015592
#*# 	0.020764, 0.028151, 0.011131, 0.003027, 0.000049, -0.004851, -0.001311, 0.003869, 0.014863, 0.018609, 0.018637, 0.014175, 0.000945, -0.009939, -0.006039, -0.009126, -0.021797, -0.019937, -0.022960, -0.027203, -0.011044
#*# 	0.036310, 0.030323, 0.025251, 0.018578, 0.009588, 0.002956, 0.001617, 0.016594, 0.025413, 0.029332, 0.014440, 0.005012, 0.010636, 0.005287, 0.000481, -0.008480, -0.016899, -0.026781, -0.023351, -0.017306, -0.000817
#*# 	0.049675, 0.036560, 0.029667, 0.017086, 0.011495, 0.012984, 0.011992, 0.020648, 0.025778, 0.020648, 0.026330, 0.022908, 0.014033, 0.009895, -0.002748, -0.000930, -0.009449, -0.022412, -0.026250, -0.020261, -0.006610
#*# 	0.047129, 0.032917, 0.024376, 0.017842, 0.018893, 0.011978, 0.009551, 0.018449, 0.024627, 0.022199, 0.014406, 0.010287, 0.004226, 0.006463, -0.002331, -0.011013, -0.017583, -0.029557, -0.035486, -0.014210, -0.013907
#*# 	0.041281, 0.037260, 0.028546, 0.008917, 0.009909, 0.013713, 0.016249, 0.022426, 0.023971, 0.026506, 0.022483, 0.020386, 0.009746, 0.004878, -0.014140, -0.015768, -0.010943, -0.020070, -0.027450, -0.026637, -0.011524
#*# 	0.058042, 0.037648, 0.030974, 0.021432, 0.009250, 0.010241, 0.017247, 0.028163, 0.031689, 0.027447, 0.017105, 0.010213, -0.001904, -0.014574, -0.015911, -0.017248, -0.025268, -0.035670, -0.029162, -0.025850, -0.026140
#*# 	0.050248, 0.048838, 0.041014, 0.026621, 0.021274, 0.013448, 0.011514, 0.016042, 0.023981, 0.026021, 0.021942, 0.018339, 0.010142, -0.006698, -0.013076, -0.009473, -0.017667, -0.017899, -0.026733, -0.026443, -0.016505
#*# 	0.067051, 0.049000, 0.041915, 0.036482, 0.026008, 0.017906, 0.018288, 0.024578, 0.031631, 0.029038, 0.016305, 0.012502, 0.005335, -0.000605, -0.001087, -0.009487, -0.016751, -0.019420, -0.021571, -0.018955, -0.020815
#*# 	0.063744, 0.057265, 0.052084, 0.037635, 0.030307, 0.023082, 0.021375, 0.024845, 0.033003, 0.025178, 0.021318, 0.022529, 0.023853, 0.014370, 0.009795, 0.004903, 0.008194, -0.000827, -0.004204, -0.014597, -0.003583
#*# 	0.072571, 0.053527, 0.054001, 0.049858, 0.033718, 0.029915, 0.029084, 0.032170, 0.039061, 0.032170, 0.026328, 0.019714, 0.010506, 0.017341, 0.010945, 0.007914, -0.001098, -0.003598, -0.010603, -0.008394, -0.009732
#*# 	0.062985, 0.060097, 0.049398, 0.036899, 0.039100, 0.031598, 0.029616, 0.032923, 0.023498, 0.026091, 0.029894, 0.025090, 0.022669, 0.014559, 0.009269, 0.010976, 0.000675, -0.001641, -0.005165, -0.015567, -0.005629
#*# 	0.064981, 0.047078, 0.049481, 0.046783, 0.035699, 0.033442, 0.024179, 0.026276, 0.031068, 0.030573, 0.021368, 0.020157, 0.014259, 0.017324, 0.017658, 0.008582, -0.001518, -0.010793, -0.008642, -0.008236, -0.008120
#*# 	0.045142, 0.041948, 0.044995, 0.034611, 0.029046, 0.032135, 0.029046, 0.023205, 0.021808, 0.026074, 0.018352, 0.022374, 0.014053, 0.016036, 0.006055, 0.000868, -0.000224, 0.000001, 0.000839, -0.004675, -0.013023
#*# 	0.045935, 0.032329, 0.031339, 0.033932, 0.031834, 0.021800, 0.020094, 0.021085, 0.018331, 0.027041, 0.015186, 0.013643, 0.008792, 0.010107, 0.008147, -0.002291, -0.006982, -0.005751, -0.012213, -0.009191, -0.013665
#*# 	0.022445, 0.031649, 0.018701, 0.021236, 0.015138, 0.014861, 0.010011, 0.012051, 0.013318, 0.013813, 0.013261, 0.015633, 0.017121, 0.010175, 0.008467, -0.000598, 0.008963, -0.006180, -0.008098, -0.016515, -0.002451
#*# 	0.022779, 0.008157, 0.010706, 0.010540, 0.012742, 0.005058, 0.001184, 0.005346, 0.008444, 0.012083, 0.013790, 0.002783, 0.002273, 0.009656, 0.006844, 0.000562, -0.004973, -0.012132, -0.013758, -0.017245, -0.009956
#*# tension = 0.2
#*# min_x = 15.0
#*# algo = bicubic
#*# y_count = 21
#*# mesh_y_pps = 2
#*# min_y = 32.0
#*# x_count = 21
#*# max_y = 203.4
#*# mesh_x_pps = 2
#*# max_x = 197.8
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 42.913523
